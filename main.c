/*
 * modulation
 */

#define FIXED_POINT_DECIMAL 16

#include <ifx-49.h>
#include <math.h>
#include "bfin_twi_slave.h"

#define IIR_STAGE 8

struct iir_sec {
  int32_t coeff[6]; /* k, b1, b2, a0, a1, a2 */
};

/*
フィルタの種類 : BPF
フィルタの特性 : エリプティック
フィルタの次数 : 16
セクション数 : 8
サンプリング周波数 : 48000 [Hz]
ストップバンド終端周波数 : 10 [Hz]
パスバンド始端周波数 : 300 [Hz]
パスバンド終端周波数 : 2700 [Hz]
ストップバンド始端周波数 : 2990 [Hz]
パスバンド端減衰量 : 0.5 [dB]
ストップバンド端減衰量 : 60 [dB]
*/
static const struct iir_sec iir_coeff_af[IIR_STAGE] = 
{
  {
    FLOAT_TO_FR32( 1.087924517411864e-03 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( -1.937821363260693e+00 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 9.438124884488773e-01 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 1.000000000000000e+00 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( -1.999892102495321e+00 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 9.999999999999994e-01 , FIXED_POINT_DECIMAL)
  },{
    FLOAT_TO_FR32( 1.000000000000000e+00 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( -1.847799535214614e+00 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 8.774812719589616e-01 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 1.000000000000000e+00 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( -7.474584714235796e-01 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 1.000000000000000e+00 , FIXED_POINT_DECIMAL)
  },{
    FLOAT_TO_FR32( 9.977703153940110e-01 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( -1.981056292699795e+00 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 9.834768131181127e-01 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 1.000000000000000e+00 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( -1.999344184963008e+00 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 9.999999999999006e-01 , FIXED_POINT_DECIMAL)
  },{
    FLOAT_TO_FR32( 1.000000000000000e+00 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( -1.834906591073393e+00 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 9.103442726848264e-01 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 1.000000000000000e+00 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( -1.720948003387620e+00 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 1.000000000000086e+00 , FIXED_POINT_DECIMAL)
  },{
    FLOAT_TO_FR32( 9.938583265936429e-01 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( -1.993142025207384e+00 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 9.948563275953350e-01 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 1.000000000000000e+00 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( -1.998932447719205e+00 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 1.000000000000690e+00 , FIXED_POINT_DECIMAL)
  },{
    FLOAT_TO_FR32( 1.000000000000000e+00 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( -1.850882936672664e+00 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 9.599029447022973e-01 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 1.000000000000000e+00 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( -1.823851071294557e+00 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 9.999999999993707e-01 , FIXED_POINT_DECIMAL)
  },{
    FLOAT_TO_FR32( 1.001589365407906e+00 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( -1.997271475132105e+00 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 9.988044814709189e-01 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 1.000000000000000e+00 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( -1.998766744334096e+00 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 1.000000000000671e+00 , FIXED_POINT_DECIMAL)
  },{
    FLOAT_TO_FR32( 1.000000000000000e+00 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( -1.865868871952934e+00 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 9.894564840651854e-01 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 1.000000000000000e+00 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( -1.846617409979237e+00 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 9.999999999993805e-01 , FIXED_POINT_DECIMAL)
  }
};

static const struct iir_sec iir_coeff_iq[IIR_STAGE] = 
{
  {
    FLOAT_TO_FR32( 2.33874753294367937e-01 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( -1.96740508587446250e+00 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 9.96318172557196013e-01 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 2.91777046959363975e-02 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 5.83554093918727951e-02 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 2.91777046959363975e-02 , FIXED_POINT_DECIMAL),
  },{
    FLOAT_TO_FR32( 2.46973775785627236e-01 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( -1.96245100001179851e+00 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 9.89129412558237275e-01 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 2.70053090268127793e-02 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 5.40106180536255587e-02 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 2.70053090268127793e-02 , FIXED_POINT_DECIMAL),
  },{
    FLOAT_TO_FR32( 2.46382512981333263e-01 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( -1.95973082229485041e+00 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 9.82389385406481797e-01 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 2.29912452363738307e-02 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 4.59824904727476613e-02 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 2.29912452363738307e-02 , FIXED_POINT_DECIMAL),
  },{
    FLOAT_TO_FR32( 2.45951493217797468e-01 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( -1.95888233127568823e+00 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 9.76341560209071369e-01 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 1.77466181491350225e-02 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 3.54932362982700450e-02 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 1.77466181491350225e-02 , FIXED_POINT_DECIMAL),
  },{
    FLOAT_TO_FR32( 2.45659521294539995e-01 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( -1.95934601107628237e+00 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 9.71206329636357446e-01 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 1.20698746964655150e-02 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 2.41397493929310300e-02 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 1.20698746964655150e-02 , FIXED_POINT_DECIMAL),
  },{
    FLOAT_TO_FR32( 2.45477866933819622e-01 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( -1.96047204102174089e+00 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 9.67173829919373285e-01 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 6.82524760922670077e-03 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 1.36504952184534015e-02 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 6.82524760922670077e-03 , FIXED_POINT_DECIMAL),
  },{
    FLOAT_TO_FR32( 2.45377069417111987e-01 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( -1.96163695524280213e+00 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 9.64396155430989999e-01 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 2.81118381878775470e-03 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 5.62236763757550939e-03 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 2.81118381878775470e-03 , FIXED_POINT_DECIMAL),
  },{
    FLOAT_TO_FR32( 2.45333301276136256e-01 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( -1.96235297819794363e+00 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 9.62979842220236359e-01 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 6.38788149664137254e-04 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 1.27757629932827451e-03 , FIXED_POINT_DECIMAL),
    FLOAT_TO_FR32( 6.38788149664137254e-04 , FIXED_POINT_DECIMAL),
  }
};
#define FIR_COEFF 85
/*
static const int32_t fir_coeff_iq[FIR_COEFF] = 
{
FLOAT_TO_FR32( 1.427548305447095e-04 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 2.193260411539834e-04 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 3.070755753425805e-04 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 3.987420084142498e-04 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 4.839637191088410e-04 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 5.494484663889444e-04 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 5.794617928738643e-04 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 5.566543950346569e-04 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 4.632229545003888e-04 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 2.823701794509066e-04 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -4.201128971435425e-19 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -3.934446636087927e-04 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -9.011189166807750e-04 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -1.518023667197730e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -2.229510471863715e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -3.010190127001683e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -3.823381056086275e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -4.621211670378158e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -5.345458346488362e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -5.929158937377059e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -6.298993090465109e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -6.378368063427483e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -6.091095693195304e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -5.365496454242200e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -4.138723916099332e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -2.361070880800956e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 1.658195130916113e-18 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 2.956361111501164e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 6.496506186348960e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 1.058383303904234e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 1.515609112102716e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 2.012610233992324e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 2.538379364731343e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 3.079950417137250e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 3.622845291027690e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 4.151618020666749e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 4.650471228165808e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 5.103914745169932e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 5.497432893515480e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 5.818125497487563e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 6.055288369723245e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 6.200901766167943e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 6.250000000000000e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 6.200901766167943e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 6.055288369723245e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 5.818125497487563e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 5.497432893515480e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 5.103914745169932e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 4.650471228165808e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 4.151618020666749e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 3.622845291027690e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 3.079950417137250e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 2.538379364731343e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 2.012610233992324e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 1.515609112102716e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 1.058383303904234e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 6.496506186348960e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 2.956361111501164e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 1.658195130916113e-18 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -2.361070880800956e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -4.138723916099332e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -5.365496454242200e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -6.091095693195304e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -6.378368063427483e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -6.298993090465109e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -5.929158937377059e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -5.345458346488362e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -4.621211670378158e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -3.823381056086275e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -3.010190127001683e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -2.229510471863715e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -1.518023667197730e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -9.011189166807750e-04 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -3.934446636087927e-04 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -4.201128971435425e-19 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 2.823701794509066e-04 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 4.632229545003888e-04 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 5.566543950346569e-04 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 5.794617928738643e-04 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 5.494484663889444e-04 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 4.839637191088410e-04 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 3.987420084142498e-04 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 3.070755753425805e-04 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 2.193260411539834e-04 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 1.427548305447095e-04, FIXED_POINT_DECIMAL),
};
/*
static const int32_t fir_coeff_hilb[FIR_COEFF] = 
{
FLOAT_TO_FR32( 2.501302599590436e-04 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -8.067058311623161e-08 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 2.880339608982269e-04 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -1.383402445626635e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 4.485181569113437e-04 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -1.657991338363323e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 6.632025182478185e-04 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -1.778923680773740e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 9.434995169070118e-04 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -1.928100902141404e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 1.302130421029279e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -2.253311076964860e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 1.753241015585391e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -2.923613895082227e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 2.312586163394494e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -3.337135288154503e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 2.997594456009162e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -4.903808025904908e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 3.827851753614046e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -4.009490583084027e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 4.825161299515629e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -6.104149364766908e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 6.014795266088176e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -4.621043891614622e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 7.425663224988756e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -5.344202455297920e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 9.092527293758035e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -6.612947248713248e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 1.105777921615969e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -5.899178189088605e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 1.337469221918883e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -5.753719982657624e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 1.611287339809847e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -6.220660806253248e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 1.936643364435603e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -5.887270557880028e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 2.326731513640362e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -4.523627988354837e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 2.800864656820040e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -4.462601387966179e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 3.388641385620411e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -4.708418882524176e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 4.138012995298834e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -4.747722037486740e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 5.132041570402468e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -3.456218220416633e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 6.528160108619030e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -2.257072437253003e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 8.664579375292081e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -2.272433377330097e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 1.242211082540312e-01 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -2.185716323212952e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 2.103321969692029e-01 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -1.395933788195703e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 6.359928445607932e-01 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -6.359928445607932e-01 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 1.395933788195703e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -2.103321969692029e-01 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 2.185716323212952e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -1.242211082540312e-01 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 2.272433377330097e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -8.664579375292081e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 2.257072437253003e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -6.528160108619030e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 3.456218220416633e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -5.132041570402468e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 4.747722037486740e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -4.138012995298834e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 4.708418882524176e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -3.388641385620411e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 4.462601387966179e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -2.800864656820040e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 4.523627988354837e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -2.326731513640362e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 5.887270557880028e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -1.936643364435603e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 6.220660806253248e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -1.611287339809847e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 5.753719982657624e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -1.337469221918883e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 5.899178189088605e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -1.105777921615969e-02 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 6.612947248713248e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -9.092527293758035e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 5.344202455297920e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -7.425663224988756e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 4.621043891614622e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -6.014795266088176e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 6.104149364766908e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -4.825161299515629e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 4.009490583084027e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -3.827851753614046e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 4.903808025904908e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -2.997594456009162e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 3.337135288154503e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -2.312586163394494e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 2.923613895082227e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -1.753241015585391e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 2.253311076964860e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -1.302130421029279e-03 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 1.928100902141404e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -9.434995169070118e-04 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 1.778923680773740e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -6.632025182478185e-04 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 1.657991338363323e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -4.485181569113437e-04 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 1.383402445626635e-07 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -2.880339608982269e-04 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 8.067058311623161e-08 , FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( -2.501302599590436e-04 , FIXED_POINT_DECIMAL)
};

static const int32_t fir_coeff_hilbdelay[FIR_COEFF] = 
{
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 1.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL),
FLOAT_TO_FR32( 0.000000000000000e+00, FIXED_POINT_DECIMAL)
};
*/
static int32_t iir_delay_af_in[IIR_STAGE][2] = {0};
static int32_t iir_delay_af_out[IIR_STAGE][2] = {0};
static int32_t iir_delay_i_out[IIR_STAGE][2] = {0};
static int32_t iir_delay_q_out[IIR_STAGE][2] = {0};
static int16_t fir_delay_pos_in = 0;
static int32_t fir_delay_i_in[FIR_COEFF] = {0};
static int32_t fir_delay_q_in[FIR_COEFF] = {0};
static int16_t fir_delay_pos_out = 0;
static int32_t fir_delay_i_out[FIR_COEFF] = {0};
static int32_t fir_delay_q_out[FIR_COEFF] = {0};

#define SSB_MODE_USB 1
#define SSB_MODE_LSB 0

DECL_INT_HANDLER(gptimer0_isr);

/* スイッチを押すたびに変化(タイマにて処理) */
static int32_t mode = 0;

static int16_t modulation_state = 0; //0x00 = AM, 0x10 = FM(NB), 0x11 = FM(SNB), 0x20 = SSB(USB), 0x21 = SSB(LSB)

static uint8_t s_twi_slave_callback_xmit(void) {
  return 0;
}

static void s_twi_slave_callback_recv(uint8_t* p_buf, int16_t count) {
  if(count == 2) {
    switch(p_buf[0]) {
      case 0:
        mode = p_buf[1];
        break;
      case 1:
        modulation_state = p_buf[1];
        break;
    }
  }
}

int main( void )
{
    /* ボード初期化 */
    ifx49_init();

    /* I2C slave設定 */
    bfin_twi_slave_init(0b0011011, s_twi_slave_callback_xmit, s_twi_slave_callback_recv);
    //s_us_delay(10 * 1000);  // 10ms

    /* ADAU1361初期化 */
    adau1361_init();
    
    /* TIMER0起動(5ms単位) */
    bfin_timer0_start(50, gptimer0_isr);
    
    /* ADAU1361サンプリング開始 */
    adau1361_enable();
    while(1)
    {
        idle();
        adau1361_data_check();
    }

    return 0;
}

/* Sineを算出(Visual DSP++ HELPのsin_fr16参照) */
int16_t sin2pi_fr16(int16_t x)
{ 
    if(x < 0x2000) /* <0.25  */
    {
        /* first quadrant [0..π/2): */
        /* sin_fr16([0x0..0x7fff]) = [0..0x7fff)   */
        return sin_fr16(x * 4);
    }
    else if(x == 0x2000) /* = 0.25 */
    {
        return 0x7FFF;
    }
    else if(x < 0x6000) /* < 0.75  */
    {
        /* if (x < 0x4000) */
        /* second quadrant [π/2..π): */
        /* -sin_fr16([0x8000..0x0)) = [0x7fff..0) */
        
        /* if (x < 0x6000) */
        /* third quadrant [π..3/2π): */
        /* -sin_fr16([0x0..0x7fff]) = [0..0x8000) */
        /* ※gccの場合、引数をint16_tへの明示的な変換が必要 */
        return -sin_fr16((int16_t)((0xC000 + x) * 4));
    }
    else
    {
        /* fourth quadrant [3/2π..2π): */
        /* sin_fr16([0x8000..0x0)) = [0x8000..0) */
        /* ※gccの場合、引数をint16_tへの明示的な変換が必要 */
        return sin_fr16((int16_t)((0x8000 + x) * 4));
    }
}

//#define AUTOPAN_FREQ        0.2 // Hz
//#define AUDIO_FREQ          440.0 // Hz
//
//static void gen_sine(const int32_t* p_rxbuf[2], int32_t* p_txbuf[2])
//{
//    /* sine関数の変数初期化 */
//    static uint32_t sf_sine_diff = (FLOAT_TO_Q31((float)AUDIO_FREQ / (float)SAMPLING_RATE));
//    static uint32_t sf_sine_idx = 0; /* sin関数のindex. Q1.31 */
//    int32_t l_lc; /* サンプリング数のカウンタ */
//    
//    for(l_lc = 0; l_lc < NUM_SAMPLES; l_lc++)
//    {
//        p_txbuf[0][l_lc] = sin2pi_fr16((sf_sine_idx >> (31-15)) & 0x7FFF) << (FIXED_POINT_DECIMAL - 15);
//        p_txbuf[1][l_lc] = sin2pi_fr16((sf_sine_idx >> (31-15)) & 0x7FFF) << (FIXED_POINT_DECIMAL - 15);
//        sf_sine_idx += sf_sine_diff;
//    }
//}

/* 3000Hz LPF */
static void iir_af(const int32_t s, const struct iir_sec* coeff, int32_t delay[][2], int32_t* ps) {
  int16_t l_stage;
  int32_t l_w, l_y;
 
  l_w = s;
  for (l_stage = 0; l_stage < IIR_STAGE; l_stage++) {
    l_w  = mult_fr32(coeff[l_stage].coeff[0], l_w);
    l_w -= mult_fr32(coeff[l_stage].coeff[1], delay[l_stage][0]);
    l_w -= mult_fr32(coeff[l_stage].coeff[2], delay[l_stage][1]);
    l_y  = mult_fr32(coeff[l_stage].coeff[3], l_w);
    l_y += mult_fr32(coeff[l_stage].coeff[4], delay[l_stage][0]);
    l_y += mult_fr32(coeff[l_stage].coeff[5], delay[l_stage][1]);

    delay[l_stage][1] = delay[l_stage][0];
    delay[l_stage][0] = l_w;
    l_w = l_y;
  }
  *ps = l_y;
}

static void iir_iq(const int32_t i, const int32_t q,
  const struct iir_sec* coeff, 
  int32_t delay_i[][2], int32_t delay_q[][2],
  int32_t* pi, int32_t* pq) {
  int16_t l_stage;
  int32_t l_wi, l_yi;
  int32_t l_wq, l_yq;
 
  l_wi = i;
  l_wq = q;
  for (l_stage = 0; l_stage < IIR_STAGE; l_stage++) {
    l_wi  = mult_fr32(coeff[l_stage].coeff[0], l_wi);
    l_wq  = mult_fr32(coeff[l_stage].coeff[0], l_wq);
    l_wi -= mult_fr32(coeff[l_stage].coeff[1], delay_i[l_stage][0]);
    l_wq -= mult_fr32(coeff[l_stage].coeff[1], delay_q[l_stage][0]);
    l_wi -= mult_fr32(coeff[l_stage].coeff[2], delay_i[l_stage][1]);
    l_wq -= mult_fr32(coeff[l_stage].coeff[2], delay_q[l_stage][1]);
    l_yi  = mult_fr32(coeff[l_stage].coeff[3], l_wi);
    l_yq  = mult_fr32(coeff[l_stage].coeff[3], l_wq);
    l_yi += mult_fr32(coeff[l_stage].coeff[4], delay_i[l_stage][0]);
    l_yq += mult_fr32(coeff[l_stage].coeff[4], delay_q[l_stage][0]);
    l_yi += mult_fr32(coeff[l_stage].coeff[5], delay_i[l_stage][1]);
    l_yq += mult_fr32(coeff[l_stage].coeff[5], delay_q[l_stage][1]);

    delay_i[l_stage][1] = delay_i[l_stage][0];
    delay_q[l_stage][1] = delay_q[l_stage][0];
    delay_i[l_stage][0] = l_wi;
    delay_q[l_stage][0] = l_wq;
    l_wi = l_yi;
    l_wq = l_yq;
  }
  *pi = l_yi;
  *pq = l_yq;
}

static void fir_iq(
    const int32_t i, const int32_t q,
    const int32_t* ci, const int32_t* cq,
    int32_t* delay_i, int32_t* delay_q, int16_t* pos,  
    int32_t* pi, int32_t* pq) {
  uint16_t index_coeff, index_delay;
  int32_t oi = 0, oq = 0;
 
  delay_i[*pos] = i;
  delay_q[*pos] = q;                                                                                 
  
  for (index_coeff = 0, index_delay = *pos;
    index_coeff < FIR_COEFF; index_coeff++) {
    oi += mult_fr32(ci[index_coeff], delay_i[index_delay]);
    oq += mult_fr32(cq[index_coeff], delay_q[index_delay]);
    index_delay = (index_delay + FIR_COEFF - 1) % FIR_COEFF;
  }
  *pos = (*pos + 1) % FIR_COEFF;
  *pi = oi;
  *pq = oq;
}

int32_t inline sqrt2(int32_t f) {
  int32_t s = f, t;

  if(f == 0) return 0;
  
  do {
    t = s;
    s = (t + div_fr32(f, t)) >> 1;
  }while(s < t); 
  
  return t;
}

// SSB変調
static void modulate_ssb(const int32_t* p_rxbuf[2], int32_t* p_txbuf[2], int ssb_mode) {
  static int16_t index_dbm = 0;
  int16_t l_lc;
  int32_t l_w, l_y, l_i, l_q;
  for(l_lc = 0; l_lc < NUM_SAMPLES; l_lc++) {
    // 入力のモノラル化
    l_w = mult_fr32(p_rxbuf[0][l_lc] >> 8, FLOAT_TO_FR32(0.5, FIXED_POINT_DECIMAL))
        + mult_fr32(p_rxbuf[1][l_lc] >> 8, FLOAT_TO_FR32(0.5, FIXED_POINT_DECIMAL));
    //l_w = sin2pi_fr16((sf_sine_idx >> (31-15)) & 0x7FFF) << (FIXED_POINT_DECIMAL - 15);
    //sf_sine_idx += sf_sine_diff;
 
    // 3000Hz AF IIR LPF
    iir_af(l_w, iir_coeff_af, iir_delay_af_in, &l_y);
 
    // Modulation with 1500HZ pulse
    if ((index_dbm & 0x18) == 0x00) {
        l_i = l_y;
        l_q = -l_y;
    } else if ((index_dbm & 0x18) == 0x08) {
        l_i = l_y;
        l_q = l_y;
    } else if ((index_dbm & 0x18) == 0x10) {
        l_i = -l_y;
        l_q = l_y;
    } else if ((index_dbm & 0x18) == 0x18) {
        l_i = -l_y;
        l_q = -l_y;
    }
    index_dbm = (index_dbm + 1) & 0x1f;

    // filtering I/Q 1200Hz
    //fir_iq(l_i, l_q, fir_coeff_iq, fir_coeff_iq, fir_delay_i_out, fir_delay_q_out, &fir_delay_pos_out, &l_i, &l_q);
    iir_iq(l_i, l_q, iir_coeff_iq, iir_delay_i_out, iir_delay_q_out, &l_i, &l_q);

    if (ssb_mode) {//usb mode
      l_q = -l_q; // shift 180degree
    }
 
    // output I/Q
    p_txbuf[0][l_lc] = l_i << 8;
    p_txbuf[1][l_lc] = l_q << 8;
  }
}

// SSB復調
static void demodulate_ssb(const int32_t* p_rxbuf[2], int32_t* p_txbuf[2], int ssb_mode) {
  static int16_t index_dbm = 3;
  int16_t l_lc;
  int32_t l_y, l_i, l_q;

  for(l_lc = 0; l_lc < NUM_SAMPLES; l_lc++) {
    // Get I/Q
    l_i = p_rxbuf[0][l_lc] >> 8;
    l_q = p_rxbuf[1][l_lc] >> 8;

    // filtering I/Q 1200Hz
    //fir_iq(l_i, l_q, fir_coeff_iq, fir_coeff_iq, fir_delay_i_in, fir_delay_q_in, &fir_delay_pos_in, &l_i, &l_q);
    iir_iq(l_i, l_q, iir_coeff_iq, iir_delay_i_out, iir_delay_q_out, &l_i, &l_q);

    // Modulation with 1500HZ pulse
    if ((index_dbm & 0x18) == 0x00) {
        l_i = l_i;
        l_q = -l_q;
    } else if ((index_dbm & 0x18) == 0x08) {
        l_i = l_i;
        l_q = l_q;
    } else if ((index_dbm & 0x18) == 0x10) {
        l_i = -l_i;
        l_q = l_q;
    } else if ((index_dbm & 0x18) == 0x18) {
        l_i = -l_i;
        l_q = -l_q;
    }
    index_dbm = (index_dbm + 1) & 0x1f;
    
    /* added(lsb) or subtract(usb) */
    if (ssb_mode) {
      l_q = -l_q;
    }
    l_y = mult_fr32(l_i, FLOAT_TO_FR32(0.5,FIXED_POINT_DECIMAL))
        + mult_fr32(l_q, FLOAT_TO_FR32(0.5,FIXED_POINT_DECIMAL));

    /*3000Hz AF IIR LPF*/
    iir_af(l_y, iir_coeff_af, iir_delay_af_out, &l_y);
    
    /* output */
    p_txbuf[0][l_lc] = l_y << 8;
    p_txbuf[1][l_lc] = l_y << 8;
  }
}

static void modulate_am(const int32_t* p_rxbuf[2], int32_t* p_txbuf[2]) {
  int16_t l_lc;
  int32_t l_y, l_w;

  for(l_lc = 0; l_lc < NUM_SAMPLES; l_lc++) {
    // 入力のモノラル化
    l_w = mult_fr32(p_rxbuf[0][l_lc] >> 8, FLOAT_TO_FR32(0.5, FIXED_POINT_DECIMAL))
        + mult_fr32(p_rxbuf[1][l_lc] >> 8, FLOAT_TO_FR32(0.5, FIXED_POINT_DECIMAL));
    // 3000Hz AF IIR LPF
    iir_af(l_w, iir_coeff_af, iir_delay_af_in, &l_y);

    // add DC component and reduce dynamic range
    l_y = ((l_y << 8) + (1 << 24)) >> 1;

    /* output */
    p_txbuf[0][l_lc] = l_y;
    p_txbuf[1][l_lc] = 0; //set zero to quadrature
  }
}

static void demodulate_am(const int32_t* p_rxbuf[2], int32_t* p_txbuf[2]) {
  int16_t l_lc;
  int32_t l_y, l_i, l_q;

  for(l_lc = 0; l_lc < NUM_SAMPLES; l_lc++) {
    // Get I/Q
    l_i = p_rxbuf[0][l_lc] >> 8;
    l_q = p_rxbuf[1][l_lc] >> 8;

    // calc norm
    l_y = sqrt2(mult_fr32(l_i, l_i) + mult_fr32(l_q, l_q));

    /*3000Hz AF IIR LPF*/
    iir_af(l_y, iir_coeff_af, iir_delay_af_out, &l_y);
    
    /* output */
    p_txbuf[0][l_lc] = l_y << 8;
    p_txbuf[1][l_lc] = l_y << 8;
  }
}

static void modulate_fm(const int32_t* p_rxbuf[2], int32_t* p_txbuf[2]) {
  int16_t l_lc;
  int32_t l_y, l_w;
  static uint32_t sine_diff = (FLOAT_TO_Q31((float)5000.0 / (float)SAMPLING_RATE)); //最大周波数偏移を5khzに（バンド幅が10khzに）スーパーナロウは2.5khzらしい
  static uint32_t phase = 0;

  for(l_lc = 0; l_lc < NUM_SAMPLES; l_lc++) {
    // 入力のモノラル化
    l_w = mult_fr32(p_rxbuf[0][l_lc] >> 8, FLOAT_TO_FR32(0.5, FIXED_POINT_DECIMAL))
        + mult_fr32(p_rxbuf[1][l_lc] >> 8, FLOAT_TO_FR32(0.5, FIXED_POINT_DECIMAL));

    // 3000Hz AF IIR LPF
    iir_af(l_w, iir_coeff_af, iir_delay_af_in, &l_y);
    
    // I/Qを生成する
    p_txbuf[0][l_lc] = sin2pi_fr16(((phase >> (31-15)) + 0x0000) & 0x7FFF) << (24 - 15); //sin
    p_txbuf[1][l_lc] = sin2pi_fr16(((phase >> (31-15)) + 0x2000) & 0x7FFF) << (24 - 15); //cos

    phase += mult_fr32(l_w, sine_diff); //Q16.16 * Q1.31だが関数内でQ16.16分の影響を相殺しているので結果はQ1.31 
  }
}

static void demodulate_fm(const int32_t* p_rxbuf[2], int32_t* p_txbuf[2]) {
  int16_t l_lc;
  int32_t l_y, l_i, l_q, l_i_d, l_q_d;
  static uint32_t sine_diff = (FLOAT_TO_Q31((float)5000.0 / (float)SAMPLING_RATE)); //最大周波数偏移を5khzに（バンド幅が10khzに）スーパーナロウは2.5khzらしい
  static uint32_t phase = 0;
  static int32_t i_state[2]={0}, q_state[2]={0};

  //refs : http://www.embedded.com/design/configurable-systems/4212086/DSP-Tricks--Frequency-demodulation-algorithms-
  for(l_lc = 0; l_lc < NUM_SAMPLES; l_lc++) {
    // Get I/Q
    l_i = p_rxbuf[0][l_lc] >> 8;
    l_q = p_rxbuf[1][l_lc] >> 8;

    // calc differential
    l_i_d = l_i - i_state[1];
    l_q_d = l_q - q_state[1];

    // merge and scale
    l_y = mult_fr32(i_state[0], l_q_d) - mult_fr32(q_state[0], l_i_d);
    l_y = mult_fr32(l_y, FLOAT_TO_FR32(0.5, FIXED_POINT_DECIMAL));

    /*3000Hz AF IIR LPF*/
    iir_af(l_y, iir_coeff_af, iir_delay_af_out, &l_y);
    
    /* output */
    p_txbuf[0][l_lc] = l_y << 8;
    p_txbuf[1][l_lc] = l_y << 8;

    //shift states
    i_state[1] = i_state[0];
    i_state[0] = l_i;
    q_state[1] = q_state[0];
    q_state[0] = l_q;
  }
}


void codec_audio_process(const int32_t* p_rxbuf[2], int32_t* p_txbuf[2]) {
  if (mode == 0) {
    switch(modulation_state) {
      case 0x00:
        modulate_am(p_rxbuf, p_txbuf);
        break;
      case 0x10:
        modulate_fm(p_rxbuf, p_txbuf);
        break;
      case 0x20:
        modulate_ssb(p_rxbuf, p_txbuf, SSB_MODE_USB);
        break;
      case 0x21:
        modulate_ssb(p_rxbuf, p_txbuf, SSB_MODE_LSB);
        break;
      default:
        break;
    }
  } else {
    switch(modulation_state) {
      case 0x00:
        demodulate_am(p_rxbuf, p_txbuf);
        break;
      case 0x10:
        demodulate_fm(p_rxbuf, p_txbuf);
        break;
      case 0x20:
        demodulate_ssb(p_rxbuf, p_txbuf, SSB_MODE_USB);
        break;
      case 0x21:
        demodulate_ssb(p_rxbuf, p_txbuf, SSB_MODE_LSB);
        break;
      default:
        break;
    }
  }
}

DECL_INT_HANDLER(gptimer0_isr)
{
    static uint8_t sw0_state_prev = SW0_RELEASE;
    uint8_t sw0_state;
    uint8_t sw0_xor;

    sw0_state = bfin_sw0_status();
    sw0_xor = sw0_state ^ sw0_state_prev;
    if(sw0_xor && sw0_state)
    {
        mode = !mode;
        bfin_led0_toggle();
    }
    sw0_state_prev = sw0_state;

    /* 割り込みステータスの更新 */
    *pTIMER_STATUS = TIMIL0;
    ssync();
}
